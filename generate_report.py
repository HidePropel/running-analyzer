# generate_report.py
import json
from typing import Dict, List, Any, Optional


INPUT_JSON = "analysis_result.json"
OUTPUT_TXT = "running_report.txt"


def _fmt(x: float, digits: int = 1) -> str:
    return f"{x:.{digits}f}"


def _load_metrics(path: str) -> Dict[str, Dict[str, Any]]:
    """analysis_result.jsonì„ ì½ì–´ì„œ name ê¸°ì¤€ dictë¡œ ë³€í™˜."""
    with open(path, "r", encoding="utf-8") as f:
        data = json.load(f)

    metrics_by_name: Dict[str, Dict[str, Any]] = {}
    for m in data.get("metrics", []):
        name = m.get("name")
        if not name:
            continue
        metrics_by_name[name] = m
    return metrics_by_name


def _summary_from_per_frame(values: List[float]) -> Optional[Dict[str, float]]:
    if not values:
        return None
    return {
        "min": min(values),
        "max": max(values),
        "mean": sum(values) / len(values),
    }


# -------------------------------------------------------------------
#  ê° ì§€í‘œë³„ ì½”ì¹­ ë¬¸ì¥ ìƒì„± í•¨ìˆ˜
# -------------------------------------------------------------------
def _report_knee_angle(metric: Dict[str, Any]) -> str:
    vals = metric.get("per_frame", [])
    s = _summary_from_per_frame(vals)
    if not s:
        return "[ë¬´ë¦ ê°ë„]\në°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•Šì•„ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n"

    mn, mx, mean = s["min"], s["max"], s["mean"]

    header = (
        "[ë¬´ë¦ ê°ë„]\n"
        f"í‰ê·  ë¬´ë¦ ê°ë„ëŠ” {_fmt(mean)}Â° (ìµœì†Œ {_fmt(mn)}Â°, ìµœëŒ€ {_fmt(mx)}Â°) ì…ë‹ˆë‹¤.\n"
    )

    # í‰ê°€ ë¡œì§
    if 115 <= mean <= 140:
        body = (
            "âœ… ê°•ì  - ì°©ì§€ ì§í›„ì—ëŠ” ì¶©ë¶„íˆ êµ½í˜€ ì¶©ê²©ì„ í¡ìˆ˜í•˜ê³ , "
            "ìŠ¤ìœ™ êµ¬ê°„ì—ì„œëŠ” ê³¼í•˜ê²Œ í´ì§€ì§€ ì•Šì•„ ì¶”ì§„ë ¥ê³¼ ì—ë„ˆì§€ íš¨ìœ¨ì´ ì˜ ê· í˜•ì„ ì´ë£¨ê³  ìˆìŠµë‹ˆë‹¤. "
            "í˜„ì¬ ë¬´ë¦ ì‚¬ìš© íŒ¨í„´ì€ ìƒê¸‰ì ì£¼ìì™€ ë§¤ìš° ìœ ì‚¬í•œ í˜•íƒœì…ë‹ˆë‹¤.\n"
        )
    elif mean < 115:
        body = (
            "âš  ê°œì„  ê¶Œì¥ - ì „ë°˜ì ìœ¼ë¡œ ë¬´ë¦ êµ½í˜ì´ ë§ì€ í¸ì…ë‹ˆë‹¤. "
            "ì§€ë©´ ì ‘ì´‰ ì‹œê°„ì€ ì¤„ì–´ë“¤ ìˆ˜ ìˆì§€ë§Œ, í—ˆë²…ì§€Â·ë¬´ë¦ ì£¼ë³€ ê·¼ìœ¡ í”¼ë¡œê°€ ë¹¨ë¦¬ ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. "
            "í…œí¬ ëŸ° ì‹œì—ëŠ” ë°œì´ ì§€ë©´ì„ â€˜ì§§ê²Œ ì¹˜ê³  ë¹ ì§„ë‹¤â€™ëŠ” ëŠë‚Œìœ¼ë¡œ, "
            "ë¬´ë¦ì„ ì¡°ê¸ˆë§Œ ëœ êµ½íˆëŠ” ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ê°€ ë³´ì„¸ìš”.\n"
        )
    else:  # mean > 140
        body = (
            "âš  ê°œì„  ê¶Œì¥ - ìŠ¤ìœ™ ë’¤ìª½ êµ¬ê°„ì—ì„œ ë¬´ë¦ì´ ë§ì´ í´ì§€ë©´ì„œ "
            "ê³¼ì‹ ì „ ë˜ëŠ” ì˜¤ë²„ìŠ¤íŠ¸ë¼ì´ë“œ ê²½í–¥ì´ ë‚˜íƒ€ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤. "
            "ë’·ë‹¤ë¦¬ê°€ ë„ˆë¬´ ë©€ë¦¬ ë»—ì§€ ì•Šë„ë¡, "
            "â€˜ë°œì´ ëª¸ ì•„ë˜ì—ì„œ ë¹ ë¥´ê²Œ íšŒì „í•œë‹¤â€™ëŠ” ì´ë¯¸ì§€ë¥¼ ê°€ì§€ê³  ëŸ¬ë‹í•´ ë³´ì‹œë©´ ì¢‹ìŠµë‹ˆë‹¤.\n"
        )

    ref = "ì°¸ê³  ì´ë¯¸ì§€: snapshots/knee_angle.png\n"
    return header + body + ref + "\n"


def _report_elbow_angle(metric: Dict[str, Any]) -> str:
    vals = metric.get("per_frame", [])
    s = _summary_from_per_frame(vals)
    if not s:
        return "[íŒ”ê¿ˆì¹˜ ê°ë„]\në°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•Šì•„ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n"

    mn, mx, mean = s["min"], s["max"], s["mean"]

    header = (
        "[íŒ”ê¿ˆì¹˜ ê°ë„]\n"
        f"í‰ê·  íŒ”ê¿ˆì¹˜ ê°ë„ëŠ” {_fmt(mean)}Â° (ìµœì†Œ {_fmt(mn)}Â°, ìµœëŒ€ {_fmt(mx)}Â°) ì…ë‹ˆë‹¤.\n"
    )

    if 70 <= mean <= 110:
        body = (
            "âœ… ê°•ì  - íŒ”ì„ 90Â° ì „í›„ë¡œ ì˜ ì ‘ì–´ì„œ í”ë“¤ê³  ìˆì–´ ìƒì²´ ê· í˜•ê³¼ ë¦¬ë“¬ì´ ë§¤ìš° ì•ˆì •ì ì…ë‹ˆë‹¤. "
            "ì–´ê¹¨ê°€ ë“¤ë¦¬ì§€ ì•ŠëŠ” ì„ ì—ì„œ í˜„ì¬ ê°ë„ë¥¼ ìœ ì§€í•´ ì£¼ì‹œë©´ ì¢‹ìŠµë‹ˆë‹¤.\n"
        )
    elif mean < 70:
        body = (
            "âš  ê°œì„  ê¶Œì¥ - íŒ”ê¿ˆì¹˜ë¥¼ ë„ˆë¬´ ë§ì´ ì ‘ëŠ” ê²½í–¥ì´ ìˆì–´, "
            "ì–´ê¹¨ì™€ ëª© ì£¼ë³€ì— ê¸´ì¥ì´ ìŒ“ì´ê¸° ì‰½ìŠµë‹ˆë‹¤. "
            "â€˜íŒ”ê¿ˆì¹˜ ê°ë„ë¥¼ 90Â°ê¹Œì§€ ì¡°ê¸ˆë§Œ í´ì¤€ë‹¤â€™ëŠ” ëŠë‚Œìœ¼ë¡œ "
            "ì¡°ê¸ˆ ë” ì—¬ìœ  ìˆëŠ” íŒ” ê°ë„ë¥¼ ë§Œë“¤ì–´ ë³´ì„¸ìš”.\n"
        )
    else:  # mean > 110
        body = (
            "âš  ê°œì„  ê¶Œì¥ - íŒ”ê¿ˆì¹˜ ê°ë„ê°€ ë§ì´ í´ì§€ë©´ì„œ "
            "íŒ”ì´ ì•ë’¤ë¡œ í¬ê²Œ íœ˜ë‘˜ë¦¬ëŠ” ê²½í–¥ì´ ìˆìŠµë‹ˆë‹¤. "
            "íŒ”ì„ ëª¸ ê°€ê¹Œì´ ë‘ê³ , â€˜ìƒí•˜ ë°©í–¥ ì¤‘ì‹¬ì˜ ì§§ì€ ìŠ¤ìœ™â€™ì„ ì˜ì‹í•˜ë©´ "
            "ìƒì²´ í”ë“¤ë¦¼ê³¼ ì—ë„ˆì§€ ë‚­ë¹„ë¥¼ ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n"
        )

    ref = "ì°¸ê³  ì´ë¯¸ì§€: snapshots/elbow_angle.png\n"
    return header + body + ref + "\n"


def _report_torso_lean(metric: Dict[str, Any]) -> str:
    vals = metric.get("per_frame", [])
    s = _summary_from_per_frame(vals)
    if not s:
        return "[ìƒì²´ ê¸°ìš¸ê¸°]\në°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•Šì•„ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n"

    mn, mx, mean = s["min"], s["max"], s["mean"]

    header = (
        "[ìƒì²´ ê¸°ìš¸ê¸°]\n"
        f"í‰ê·  ìƒì²´ ê¸°ìš¸ê¸°ëŠ” {_fmt(mean)}Â° (ìµœì†Œ {_fmt(mn)}Â°, ìµœëŒ€ {_fmt(mx)}Â°) ì…ë‹ˆë‹¤.\n"
    )

    if -5 <= mean <= 10 and abs(mn) <= 15 and abs(mx) <= 15:
        body = (
            "âœ… ê°•ì  - ìƒì²´ê°€ ê³¼í•˜ê²Œ ì –í˜€ì§€ê±°ë‚˜ ìˆ™ì—¬ì§€ì§€ ì•Šê³ , "
            "ì½”ì–´ê°€ ì•ˆì •ëœ ìƒíƒœì—ì„œ ì•½ê°„ ì•ìœ¼ë¡œ ê¸°ìš¸ì–´ì§„ ì´ìƒì ì¸ í˜•íƒœì…ë‹ˆë‹¤. "
            "í˜¸í¡ê³¼ í˜ì´ìŠ¤ ìœ ì§€ì— ëª¨ë‘ ìœ ë¦¬í•œ ìì„¸ì…ë‹ˆë‹¤.\n"
        )
    elif mean < -5:
        body = (
            "âš  ê°œì„  ê¶Œì¥ - ìƒì²´ê°€ ë’¤ë¡œ ì –í˜€ì§€ëŠ” êµ¬ê°„ì´ ìˆì–´, "
            "ì§€ë©´ ë°˜ë°œë ¥ì„ ì•ìœ¼ë¡œ ë³´ë‚´ëŠ” ë° ë‹¤ì†Œ ë¹„íš¨ìœ¨ì ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. "
            "ë³µë¶€ì— ì‚´ì§ í˜ì„ ì£¼ê³ , ê°€ìŠ´ì´ ì•ìœ¼ë¡œ ë¯¸ë„ëŸ¬ì§€ë“¯ ë‚˜ê°„ë‹¤ëŠ” ëŠë‚Œì„ ì˜ì‹í•´ ë³´ì„¸ìš”.\n"
        )
    else:  # mean > 10 or ê¸°ìš¸ê¸° ë³€ë™ì´ í° ê²½ìš°
        body = (
            "âš  ê°œì„  ì—¬ì§€ - ê¸°ë³¸ì ìœ¼ë¡œëŠ” í° ë¬¸ì œëŠ” ì—†ì§€ë§Œ, "
            "ì¼ë¶€ êµ¬ê°„ì—ì„œ ìƒì²´ê°€ ë§ì´ ìˆ™ì—¬ì§€ëŠ” íŒ¨í„´ì´ ë³´ì…ë‹ˆë‹¤. "
            "ì¥ê±°ë¦¬ì—ì„œëŠ” í—ˆë¦¬Â·í—ˆë²…ì§€ ë’¤ìª½ í”¼ë¡œë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìœ¼ë‹ˆ, "
            "â€˜ì •ìˆ˜ë¦¬ê°€ ì•ìœ¼ë¡œ ë‚˜ê°„ë‹¤â€™ëŠ” ëŠë‚Œìœ¼ë¡œ ìƒì²´ë¥¼ ê³§ê²Œ ìœ ì§€í•´ ì£¼ì„¸ìš”.\n"
        )

    ref = "ì°¸ê³  ì´ë¯¸ì§€: snapshots/torso_lean.png\n"
    return header + body + ref + "\n"


def _report_head_tilt(metric: Dict[str, Any]) -> str:
    vals = metric.get("per_frame", [])
    s = _summary_from_per_frame(vals)
    if not s:
        return "[ë¨¸ë¦¬ ê¸°ìš¸ê¸°]\në°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•Šì•„ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n"

    mn, mx, mean = s["min"], s["max"], s["mean"]

    header = (
        "[ë¨¸ë¦¬ ê¸°ìš¸ê¸°]\n"
        f"í‰ê·  ë¨¸ë¦¬ ê¸°ìš¸ê¸°ëŠ” {_fmt(mean)}Â° (ìµœì†Œ {_fmt(mn)}Â°, ìµœëŒ€ {_fmt(mx)}Â°) ì…ë‹ˆë‹¤.\n"
    )

    if mean <= 10 and mx <= 25:
        body = (
            "âœ… ê°•ì  - ì‹œì„ ê³¼ ëª© ë¼ì¸ì´ ì „ë°˜ì ìœ¼ë¡œ ì•ˆì •ì ì´ë©°, "
            "ê·€ì™€ ì–´ê¹¨ì˜ ê°„ê²©ë„ ì˜ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤. "
            "í˜¸í¡ íš¨ìœ¨ê³¼ ìƒì²´ ë°¸ëŸ°ìŠ¤ ì¸¡ë©´ì—ì„œ ë§¤ìš° ì¢‹ì€ íŒ¨í„´ì…ë‹ˆë‹¤.\n"
        )
    elif mean <= 20 and mx <= 40:
        body = (
            "ğŸ‘Œ ì–‘í˜¸ - ëŒ€ë¶€ë¶„ì˜ êµ¬ê°„ì—ì„œëŠ” ì•ˆì •ì ì¸ í¸ì´ì§€ë§Œ, "
            "í˜ì´ìŠ¤ ë³€í™”ë‚˜ í”¼ë¡œë„ê°€ ì˜¬ë¼ê°ˆ ë•Œ ë¨¸ë¦¬ê°€ ì•½ê°„ ì•ìœ¼ë¡œ ë–¨ì–´ì§€ëŠ” ëª¨ìŠµì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤. "
            "â€˜ê·€ì™€ ì–´ê¹¨ë¥¼ ë©€ë¦¬ ë–¼ì–´ë‚¸ë‹¤â€™ëŠ” ëŠë‚Œìœ¼ë¡œ ëª© ì£¼ë³€ í˜ì„ ë¹¼ëŠ” ì—°ìŠµì„ í•˜ë©´ ë” ì¢‹ì•„ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n"
        )
    else:
        body = (
            "âš  ê°œì„  ê¶Œì¥ - í‰ê· ì ìœ¼ë¡œ ë¨¸ë¦¬ê°€ ì•ìœ¼ë¡œ ë§ì´ ê¸°ìš¸ì–´ì§€ëŠ” í¸ì´ë©°, "
            "ì¼ë¶€ êµ¬ê°„ì—ì„œëŠ” ê³ ê°œê°€ ìƒë‹¹íˆ ì•ìœ¼ë¡œ ì ë¦¬ëŠ” íŒ¨í„´ì´ ë³´ì…ë‹ˆë‹¤. "
            "ì´ëŠ” ìƒì²´ í•˜ë‹¨ì— ë¶ˆí•„ìš”í•œ í•˜ì¤‘ì„ ì‹¤ì–´ í—ˆë¦¬Â·ì—‰ë©ì´ í”¼ë¡œë¥¼ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. "
            "ì •ë©´ì„ ë³´ë˜ í„±ì„ ì‚´ì§ ë‹¹ê¸°ê³ , ë¨¸ë¦¬ë¥¼ ì²™ì¶” ìœ„ì— â€˜ì‚´ì§ ì˜¬ë ¤ë†“ëŠ”ë‹¤â€™ëŠ” ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ê°€ ë³´ì„¸ìš”.\n"
        )

    ref = "ì°¸ê³  ì´ë¯¸ì§€: snapshots/head_tilt.png\n"
    return header + body + ref + "\n"


def _report_foot_strike(metric: Dict[str, Any]) -> str:
    # unit: '%' ë¡œ ì •ê·œí™”ëœ ê°’ì´ë¼ê³  ê°€ì •
    vals = metric.get("per_frame", [])
    s = _summary_from_per_frame(vals)
    if not s:
        return "[ë°œ ì°©ì§€ ìœ„ì¹˜]\në°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•Šì•„ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n"

    mn, mx, mean = s["min"], s["max"], s["mean"]

    header = (
        "[ë°œ ì°©ì§€ ìœ„ì¹˜]\n"
        f"ë°œ ì°©ì§€ ìœ„ì¹˜(ì—‰ë©ì´ ê¸°ì¤€ ìˆ˜í‰ ê±°ë¦¬)ì˜ í‰ê· ì€ {_fmt(mean)}% "
        f"(ë²”ìœ„: {_fmt(mn)}% ~ {_fmt(mx)}%) ì…ë‹ˆë‹¤.\n"
    )

    if -5 <= mean <= 5 and max(abs(mn), abs(mx)) <= 25:
        body = (
            "âœ… ê°•ì  - ëŒ€ë¶€ë¶„ì˜ ì°©ì§€ê°€ ëª¸ì˜ ì¤‘ì‹¬ì„  ê·¼ì²˜ì—ì„œ ì´ë£¨ì–´ì§€ê³  ìˆìŠµë‹ˆë‹¤. "
            "ë¸Œë ˆì´í‚¹ì´ ì ê³ , ì¼€ì´ë˜ìŠ¤ë¥¼ ìœ ì§€í•˜ê¸° ì¢‹ì€ íŒ¨í„´ì…ë‹ˆë‹¤.\n"
        )
    elif -10 <= mean <= 10:
        body = (
            "ğŸ‘Œ ì–‘í˜¸ - í° ë¬¸ì œëŠ” ì—†ì§€ë§Œ, ì¼ë¶€ êµ¬ê°„ì—ì„œ ë°œì´ ëª¸ ì•ìª½ì— ì¡°ê¸ˆ ë” ë©€ë¦¬ ë–¨ì–´ì§€ëŠ” ëª¨ìŠµì´ ë³´ì…ë‹ˆë‹¤. "
            "ì¼€ì´ë˜ìŠ¤ë¥¼ 5~10 ì •ë„ë§Œ ë†’ì—¬ â€˜ë°œì´ ì—‰ë©ì´ ë°”ë¡œ ì•„ë˜ì— ë–¨ì–´ì§„ë‹¤â€™ëŠ” ëŠë‚Œìœ¼ë¡œ ì—°ìŠµí•˜ë©´ "
            "ë” ì´ìƒì ì¸ íŒ¨í„´ì— ê°€ê¹Œì›Œì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n"
        )
    elif mean > 10:
        body = (
            "âš  ê°œì„  ê¶Œì¥ - í‰ê· ì ìœ¼ë¡œ ë°œì´ ëª¸ì˜ ì•ìª½ì—ì„œ ì°©ì§€í•˜ëŠ” ê²½í–¥ì´ ìˆìŠµë‹ˆë‹¤. "
            "ì´ëŸ° íŒ¨í„´ì€ ë¸Œë ˆì´í‚¹ê³¼ ë¬´ë¦Â·ì—‰ë©ì´ ë¶€ë‹´ìœ¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. "
            "ìŠ¤í…ì„ ì¡°ê¸ˆ ë” ì§§ê²Œ ê°€ì ¸ê°€ë©°, â€˜ë¬´ë¦ ì•„ë˜ë¡œ ë°œì´ ë¹ ë¥´ê²Œ ì§€ë‚˜ê°„ë‹¤â€™ëŠ” ì´ë¯¸ì§€ë¥¼ ì˜ì‹í•´ ë³´ì„¸ìš”.\n"
        )
    else:  # mean < -10 (ë„ˆë¬´ ë’¤ìª½ ì°©ì§€) â€“ ë“œë¬¸ ê²½ìš°ì§€ë§Œ ëŒ€ë¹„
        body = (
            "âš  ì°¸ê³  - ë°œì´ ìƒëŒ€ì ìœ¼ë¡œ ëª¸ ë’¤ìª½ì—ì„œ ì ‘ì§€ë˜ëŠ” íŒ¨í„´ì´ ê´€ì°°ë©ë‹ˆë‹¤. "
            "ê³¼ë„í•œ ë’¤ê¿ˆì¹˜ ëŒë¦¼ì´ ì—†ëŠ”ì§€ ì²´í¬í•´ ë³´ì‹œê³ , "
            "í•„ìš”í•˜ë‹¤ë©´ ì°©ì§€ íƒ€ì´ë°ì„ ì•½ê°„ ì•ë‹¹ê²¨ ì§€ë©´ ì ‘ì´‰ ì‹œê°„ì„ ì¤„ì´ëŠ” ë°©í–¥ìœ¼ë¡œ ì¡°ì •í•´ ë³´ì„¸ìš”.\n"
        )

    ref = "ì°¸ê³  ì´ë¯¸ì§€: snapshots/foot_strike.png\n"
    return header + body + ref + "\n"


def _report_ankle_angle(metric: Dict[str, Any]) -> str:
    vals = metric.get("per_frame", [])
    s = _summary_from_per_frame(vals)
    if not s:
        return "[ë°œëª© ê°ë„]\në°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•Šì•„ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n"

    mn, mx, mean = s["min"], s["max"], s["mean"]

    header = (
        "[ë°œëª© ê°ë„]\n"
        f"í‰ê·  ë°œëª© ê°ë„ëŠ” {_fmt(mean)}Â° (ìµœì†Œ {_fmt(mn)}Â°, ìµœëŒ€ {_fmt(mx)}Â°) ì…ë‹ˆë‹¤.\n"
    )

    if 100 <= mean <= 125:
        body = (
            "âœ… ê°•ì  - ë°œëª©ì´ ê³¼ë„í•˜ê²Œ êº¾ì´ì§€ ì•Šìœ¼ë©´ì„œë„, "
            "ì§€ë©´ ë°˜ë°œë ¥ì„ ë°›ê¸°ì— ì¶©ë¶„í•œ íƒ„ì„±ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤. "
            "ë¯¸ë“œí’‹/í¬ì–´í’‹ ì£¼ë²•ì— ì˜ ì–´ìš¸ë¦¬ëŠ” ì•ˆì •ì ì¸ íŒ¨í„´ì…ë‹ˆë‹¤.\n"
        )
    elif mean < 100:
        body = (
            "âš  ê°œì„  ê¶Œì¥ - ë°œëª© êµ½í˜ì´ í° í¸ì´ë¼, "
            "ì¢…ì•„ë¦¬Â·ì•„í‚¬ë ˆìŠ¤ê±´ì— ë¶€ë‹´ì´ ìŒ“ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. "
            "ì§§ì€ ìŠ¤í”„ë¦°íŠ¸ë‚˜ ë°œëª© ë°˜ë™ ë“œë¦´ì„ í†µí•´, "
            "ë°œëª©ì´ ë„ˆë¬´ ê¹Šê²Œ ì ‘íˆì§€ ì•Šë„ë¡ ê°ê°ì„ ì¡°ì •í•´ ë³´ì‹œëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.\n"
        )
    else:  # mean > 125
        body = (
            "âš  ê°œì„  ê¶Œì¥ - ë°œëª© ê°ë„ê°€ ë§ì´ í´ì§€ë©´ì„œ, "
            "ì§€ë©´ì„ ê°•í•˜ê²Œ â€˜ì°ê³ â€™ ë‚˜ê°€ëŠ” íŒ¨í„´ì´ ë‚˜íƒ€ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤. "
            "ì°©ì§€ ìˆœê°„ì—ëŠ” ë°œëª©ì˜ í˜ì„ ì•½ê°„ í’€ì–´, "
            "ì§€ë©´ ë°˜ë°œë ¥ì„ ë¶€ë“œëŸ½ê²Œ ë°›ì•„ë‚¸ ë’¤ ë’¤ë¡œ ë°€ì–´ë‚´ëŠ” ëŠë‚Œì„ ì—°ìŠµí•´ ë³´ì„¸ìš”.\n"
        )

    ref = "ì°¸ê³  ì´ë¯¸ì§€: snapshots/ankle_angle.png\n"
    return header + body + ref + "\n"


def _report_knee_lift(metric: Dict[str, Any]) -> str:
    # knee_liftëŠ” % ë‹¨ìœ„ (ìƒì²´ ëŒ€ë¹„ í—ˆë²…ì§€ ë“¤ë¦¼)
    vals = metric.get("per_frame", [])
    s = _summary_from_per_frame(vals)
    if not s:
        return "[ë¬´ë¦ ë†’ì´]\në°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•Šì•„ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n"

    mn, mx, mean = s["min"], s["max"], s["mean"]

    header = (
        "[ë¬´ë¦ ë†’ì´]\n"
        f"ë¬´ë¦ ë†’ì´(ìƒì²´ ëŒ€ë¹„ í—ˆë²…ì§€ ë“¤ë¦¼)ì˜ í‰ê· ì€ {_fmt(mean)}%, "
        f"ìµœëŒ€ëŠ” {_fmt(mx)}% ìˆ˜ì¤€ì…ë‹ˆë‹¤.\n"
    )

    if 15 <= mean <= 35 and mx <= 60:
        body = (
            "âœ… ê°•ì  - ê±°ë¦¬ì£¼ìì—ê²Œ ì´ìƒì ì¸ ìˆ˜ì¤€ì˜ ë¬´ë¦ ë¦¬í”„íŠ¸ì…ë‹ˆë‹¤. "
            "ê³¼í•˜ê²Œ ë†’ì§€ë„, ë¶€ì¡±í•˜ì§€ë„ ì•Šì•„ ì—ë„ˆì§€ íš¨ìœ¨ê³¼ ì¶”ì§„ë ¥ì˜ ê· í˜•ì´ ë§¤ìš° ì¢‹ìŠµë‹ˆë‹¤.\n"
        )
    elif mean < 15:
        body = (
            "âš  ê°œì„  ê¶Œì¥ - ì „ë°˜ì ìœ¼ë¡œ ë¬´ë¦ ë“¤ë¦¼ì´ ë‚®ì€ í¸ì´ë¼, "
            "ìŠ¤í”¼ë“œë¥¼ ì˜¬ë¦´ ë•Œ ì§€ë©´ ë°˜ë°œë ¥ì„ ì¶©ë¶„íˆ í™œìš©í•˜ì§€ ëª»í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. "
            "ìŠ¤íŠ¸ë¼ì´ë“œ ë“œë¦´(ìŠ¤í‚µ, ì§§ì€ í ì—… ë“±)ì„ ì¶”ê°€í•´ ë¬´ë¦ ë¦¬í”„íŠ¸ë¥¼ ì¡°ê¸ˆë§Œ ëŒì–´ì˜¬ë ¤ ë³´ì„¸ìš”.\n"
        )
    else:  # mean > 35 or mx > 60
        body = (
            "âš  ì°¸ê³  - ë¬´ë¦ ë¦¬í”„íŠ¸ê°€ ìƒë‹¹íˆ ë†’ì€ í¸ìœ¼ë¡œ, "
            "ìŠ¤í”¼ë“œ ëŸ¬ë‹ì—ëŠ” ìœ ë¦¬í•˜ì§€ë§Œ ì¥ê±°ë¦¬ì—ì„œëŠ” ì—ë„ˆì§€ ì†Œëª¨ê°€ ì»¤ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. "
            "ë§ˆë¼í†¤ í˜ì´ìŠ¤ì—ì„œëŠ” í˜„ì¬ë³´ë‹¤ 1ë‹¨ê³„ ë‚®ì€ ë¦¬í”„íŠ¸ë¥¼ ì˜ì‹í•´ ë³´ì‹œëŠ” ê²ƒë„ ì¢‹ìŠµë‹ˆë‹¤.\n"
        )

    ref = "ì°¸ê³  ì´ë¯¸ì§€: snapshots/knee_lift.png\n"
    return header + body + ref + "\n"


def _report_arm_swing(metric: Dict[str, Any]) -> str:
    vals = metric.get("per_frame", [])
    s = _summary_from_per_frame(vals)
    if not s:
        return "[íŒ” ìŠ¤ìœ™ í­]\në°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•Šì•„ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n"

    mn, mx, mean = s["min"], s["max"], s["mean"]
    swing_range = mx - mn

    header = (
        "[íŒ” ìŠ¤ìœ™ í­]\n"
        f"íŒ” ìŠ¤ìœ™ ì•ë’¤ ë²”ìœ„ëŠ” ì•½ {_fmt(swing_range)}% ì…ë‹ˆë‹¤ "
        f"(í‰ê·  ì† ìœ„ì¹˜ {_fmt(mean)}% ê¸°ì¤€).\n"
    )

    if 20 <= swing_range <= 45:
        body = (
            "âœ… ê°•ì  - íŒ”ì´ ê³¼í•˜ê²Œ í”ë“¤ë¦¬ì§€ ì•Šìœ¼ë©´ì„œë„, "
            "ìƒì²´ ë¦¬ë“¬ì„ ë§Œë“¤ì–´ ì¤„ ë§Œí¼ì€ ì¶©ë¶„íˆ ì›€ì§ì´ê³  ìˆìŠµë‹ˆë‹¤. "
            "í˜„ì¬ ìŠ¤ìœ™ í­ì€ í˜ì´ìŠ¤ ìœ ì§€ì™€ ì—ë„ˆì§€ íš¨ìœ¨ ì¸¡ë©´ì—ì„œ ë§¤ìš° ì¢‹ì€ ìˆ˜ì¤€ì…ë‹ˆë‹¤.\n"
        )
    elif swing_range < 20:
        body = (
            "âš  ê°œì„  ê¶Œì¥ - íŒ” ìŠ¤ìœ™ í­ì´ ë‹¤ì†Œ ì‘ì€ í¸ì´ë¼, "
            "ìƒì²´ì˜ íƒ„ì„±ì´ ì¶©ë¶„íˆ ì‚´ì•„ë‚˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. "
            "íŒ”ì„ ë’¤ë¡œ ì¡°ê¸ˆ ë” ë³´ë‚¸ë‹¤ëŠ” ëŠë‚Œì„ ì¶”ê°€í•´, "
            "ë‹¤ë¦¬ì™€ ìƒì²´ ë¦¬ë“¬ì„ ë§ì¶° ì£¼ë©´ í˜ì´ìŠ¤ ìœ ì§€ì— ë„ì›€ì´ ë©ë‹ˆë‹¤.\n"
        )
    else:  # swing_range > 45
        body = (
            "âš  ê°œì„  ê¶Œì¥ - íŒ” ìŠ¤ìœ™ í­ì´ í° í¸ì´ë¼, "
            "íŠ¹íˆ í˜ì´ìŠ¤ê°€ ì˜¬ë¼ê°ˆ ë•Œ ìƒì²´ ì¢Œìš° í”ë“¤ë¦¼ìœ¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. "
            "ì†ì´ ëª¸ ì¤‘ì•™ì„ ì„ í¬ê²Œ ë„˜ì§€ ì•Šë„ë¡ í•˜ê³ , "
            "ìƒí•˜ ë°©í–¥ ì¤‘ì‹¬ì˜ ì»´íŒ©íŠ¸í•œ ìŠ¤ìœ™ì„ ì˜ì‹í•´ ë³´ì„¸ìš”.\n"
        )

    ref = "ì°¸ê³  ì´ë¯¸ì§€: snapshots/arm_swing.png\n"
    return header + body + ref + "\n"


# -------------------------------------------------------------------
#  ë©”ì¸ ë¦¬í¬íŠ¸ ìƒì„±
# -------------------------------------------------------------------
def generate_report(
    input_json: str = INPUT_JSON,
    output_txt: str = OUTPUT_TXT,
) -> None:
    metrics = _load_metrics(input_json)

    lines: List[str] = []
    lines.append("=== ëŸ¬ë‹ ìì„¸ ìë™ ë¶„ì„ ë¦¬í¬íŠ¸ ===\n")

    # ê°ê°ì˜ metricì´ ì¡´ì¬í•  ë•Œë§Œ ì„¹ì…˜ ìƒì„±
    if "right_knee_angle" in metrics:
        lines.append(_report_knee_angle(metrics["right_knee_angle"]))

    if "right_elbow_angle" in metrics:
        lines.append(_report_elbow_angle(metrics["right_elbow_angle"]))

    if "torso_lean" in metrics:
        lines.append(_report_torso_lean(metrics["torso_lean"]))

    if "head_tilt" in metrics:
        lines.append(_report_head_tilt(metrics["head_tilt"]))

    if "foot_strike_distance" in metrics:
        lines.append(_report_foot_strike(metrics["foot_strike_distance"]))

    if "right_ankle_angle" in metrics:
        lines.append(_report_ankle_angle(metrics["right_ankle_angle"]))

    if "right_knee_lift" in metrics:
        lines.append(_report_knee_lift(metrics["right_knee_lift"]))

    if "right_arm_swing" in metrics:
        lines.append(_report_arm_swing(metrics["right_arm_swing"]))

    report = "\n".join(lines)

    with open(output_txt, "w", encoding="utf-8") as f:
        f.write(report)


if __name__ == "__main__":
    generate_report()
    print(f"ë¦¬í¬íŠ¸ê°€ '{OUTPUT_TXT}' íŒŒì¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.")
